language: php

matrix:
  include:
    - php: 7.0
      env: DEPS="--prefer-lowest --prefer-stable" COVERALLS=""
    - php: 7.0
      env: DEPS="" COVERALLS=""
    - php: 7.1
      env: DEPS="--prefer-lowest --prefer-stable" COVERALLS=""
    - php: 7.1
      env: DEPS="" COVERALLS=""
    - php: 7.2
      env: DEPS="--prefer-lowest --prefer-stable" COVERALLS=""
    - php: 7.2
      env: DEPS="" COVERALLS=true
    - php: nightly
      env: DEPS="" COVERALLS=""
  allow_failures:
    - php: nightly
      env: DEPS="" COVERALLS=""
    - php: 7.1
      env: DEPS="--prefer-lowest --prefer-stable" COVERALLS=""

cache:
  directories:
    - ./vendor

before_install:
    # determine INI file
    - export INI_DIR=~/.phpenv/versions/$(phpenv version-name)/etc/conf.d
    - export INI=$INI_DIR/travis.ini
    # disable default memory limit
    - echo memory_limit = 2G >> $INI
    - if [[ $COVERALLS = "" && -f $INI_DIR/xdebug.ini ]]; then phpenv config-rm xdebug.ini; fi

install:
  - composer --prefer-source $DEPS update

script:
  - vendor/bin/phpunit
  - ./psalm --find-dead-code
  - vendor/bin/phpcs
  - bin/build-phar.sh

after_success:
  - travis_retry php vendor/bin/php-coveralls -v

deploy: # on tag builds with lowest php version (that box supports) and lowest deps
  skip_cleanup: true
  on:
    tags: true
    php: 7.1
    condition: "$DEPS"
  provider: releases
  api_key:
    secure: "oi6MZWyyBAnRyVE1SDHAfF6C6V6zsCqw5k6YuuN8t2EmYnj2Fratg/Dk9COUJXnmJ7zWmNxPDU9Or2mtRgT9ay39S15Sq90+Fs+t0dELTIYn7QcBB/3XOiI1e9/hm09NLbUDri+tsUYRbHLYoOY0H0V/JuNpN4eXpX6k06cKrznTXnFYWdYrUAgdX+MguPNFc8UDLX0nk+p9A0fjWT7S4MDqbSBPDZ/LrgQgOFFP93TjwcxqlUw2yk0svPiNirxcKUrsl4CBQ8OLAQdxL9JB9GaemUCjGMctBWIxXF7riEFrfo8KXeXA6xWczdkkI2wZe2uel4tkxmie5KEG2X+nA7pU+rQX72fjf3Ovng/0b/CewyS8m/k6V/PeKqgLYbvZoVS8bviOKQyIhI4o511G4ZynwTLlNkyDYPkl/F7bNhnhtNvDGQ6tLTF+Yepy9KO1x/0tAeHqbSX61Iihe3XY9EyauVK8Ue0OjfHajtBQaQkCmH8aYR3czASgAyCW+nUG2B/s5jDNBfDaO8Exy9GOR2kpJydebCq/esmz02lWkOcQkxGD6N08B7hADUO4U7HgYyK1eKlMzdv7lkErgWrRsjIMkzSyKrzt6bsJh7VL9KQatnyiW5G+azMukSvJ84uhcTXkYhCAKuUjEAlVI1RAellKge7lmXasRwxEPHFD6c0="
  file: build/psalm.phar
